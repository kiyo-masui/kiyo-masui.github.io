<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<title>Kiyoshi Masui - Blog/Random</title>
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="description" content="Kiyoshi Masui's personal webpage.  Kiyo doesn't actually keep a blog." />
<link rel="stylesheet" type="text/css" href="css/layout.css" media="screen, projection, tv " />
<link rel="stylesheet" type="text/css" href="css/html.css" media="screen, projection, tv " />
<script type="text/javascript"> 
<!-- 
if (document.getElementById) { window.onload = swap };
function swap() {
var numimages=13;
rndimg = new Array("images/headers/hdr1.jpg", "images/headers/hdr2.jpg",
"images/headers/hdr3.jpg", "images/headers/hdr4.jpg", "images/headers/hdr5.jpg",
"images/headers/hdr6.jpg", "images/headers/hdr7.jpg", "images/headers/hdr8.jpg",
"images/headers/hdr9.jpg", "images/headers/hdr10.jpg", "images/headers/hdr11.jpg",
"images/headers/hdr12.jpg", "images/headers/hdr13.jpg"
); 
x=(Math.floor(Math.random()*numimages));
randomimage=(rndimg[x]);
document.getElementById("headerImg").style.backgroundImage = "url("+ randomimage +")"; 
}
//--> 
</script>
</head>
<body>
<!-- #content: holds all except site footer - causes footer to stick to bottom -->
<div id="content">
  <!-- #header: holds the logo and top links -->
  <div id="header" class="width"> <span><font size="4" color='white'>Kiyoshi Masui</font></span>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="research.html">Research</a></li>
      <li><a href="teaching.html">Teaching</a></li>
      <li><a href="about.html">About Me</a></li>
      <li><a href="blog.html" class="last"><font color='white'>Blog/Random</font></a></li>
    </ul>
  </div>
  <!-- #header end -->
  <!-- #headerImg: holds the main header image or flash -->
  <div id="headerImg" class="width"></div>
  <!-- #menu: the main large box site menu -->
  <div id="menu" class="width">
    <ul>
	  <li><br/><br/></li>
	</ul>
  </div>
  <!-- #menu end -->
  <!-- #page: holds the page content -->
  <div id="page">
    <!-- #columns: holds the columns of the page -->
    <div id="columns" class="widthPad">
      <!-- Left column -->
      <div class="floatLeft width100">
	    <br/>
		<h1> Blog <span class="dark">and other random stuff</span></h1>
		<p> I don't actually keep a blog, but I do occasionally have to urge
		to write something down or share a great recipe.  This page won't be
		updated regularly but it should fill with interesting tidbits eventually.
		</p>
		<!-- -->
		<h1> <a name="memory">Dec 9, 2011:<span class="dark"> Use more memory than your machine
			  has</span></a></h1>
		<p> In performance computing, there are times when the size of the
		problem
		you can treat is limited not by computing speed, but by your
		machine's total memory.  This is the case for parts of the map making
		code I am developing.  For linear algebra, I'm using AMD graphics
		cards and the <i>acml-gpu</i> libraries to speed things up, and am now
		completely limited by the amount of memory on the machine.  I want to
		hold off working on a cluster as long as possible because waiting in a
		queue and transferring data back and forth from the cluster would slow
		development.  Just to put some numbers to things, the server I'm using
		has 144 GB of memory and 4 GPUs meaning I can deal with square matrices
		of order 100 000 on the side and each operation takes about an hour (in
		double precision).</p>
		
		<p> I have two tricks for stretching my memory further. This first is
		to use memory maps.  A memory map is essentially a file on disk that
		your machine treats as memory.  Now, your hard disk is a lot slower than
		main memory, but the beauty of a memory map is that the parts of the
		file that you are currently using get cached in memory, and so access
		and assignment are fast.  This works great if you have a
		lot of operations to perform at a time on a small part of a huge piece
		of data.  However, this requires you to be very careful.  If you access
		your data too sporadically, the program will grind to a halt.  Still
		I've found that memory map are unbelievably forgiving, and tend to
		perform quite a bit better than you would initially expect.  The memory
		map functionality is available to python users through
		<a href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.memmap.html"
		  ><i>numpy</i></a>, and is trivial to use.</p>

		<p> My second trick is much more subtle, and relies on modern operating
		systems being <a href="http://en.wikipedia.org/wiki/Virtual_memory"
		  >virtual memory systems</a>.  In a virtual memory system, physical
		memory is not allocated when a process allocates (mallocs) memory.
		Instead, virtual memory is.  Physical memory is only allocated when
		the virtual memory is used.  So when programming, you can feel free to
		allocate as much memory as you want, as long as you don't use it.  This
		is useful for me because the matrices I deal with are symmetric.  The
		linear algebra routines I'm using (standard <i>LAPACK</i> routines such
		as a Cholesky decomposition) never touch
		the lower triangular part of the matrix.  So, what I do is allocate a
		huge chunk of memory, only fill half of it, and have matrix operations
		performed in place.  On the machine I'm using, the maximum matrix size
		I can work with is 180 000 on each side, which takes about 6 hours.
		Not bad for not having to use a cluster.</p>

		<p> There is a slight complication in that <i>numpy</i> will not allow
		you to allocate more memory than your machine has (using the command
		np.empty).  I had to hack together some <i>cython</i> code so I could
		malloc the memory in <i>C</i> and convert it to a <i>numpy</i> array.
		I've posted the code below, feel free to use it, change it,
		whatever.</p>

		<script src="https://gist.github.com/1447078.js?file=large_empty.pyx"></script>
		
		<!-- -->
		<h1><a name="winter"> Oct 13, 2011:<span class="dark"> Things I'm looking forward to
		    this Winter</span></a></h1>
		<p> Winter is starting to creep up on us and if I get even one more
		camping trip in this fall I'll be lucky.  It's not all bad though,
		as winter has a few things going for it that are often neglected. 
		I tend to pack summer so tight with trips and activities, that there
		isn't a whole lot of time to enjoy the city.  Yes, despite being a
		small town guy, I've lived in 
		Toronto (rural Ontarians call it 'The Big Smoke') long enough that
		there are things I now love about it.  Here is a short list of things
		I haven't done much since last winter either because I've been sailing 
		at every possible opportunity, or because I've been out of town most
		weekends.</p>

		<p><b> Saturday morning market. </b>  In the winter, we do this more 
		often than not and get most of our food there.  In the summer, 
		it's closer to once a month.</p>

		<p><b> Weekend morning espresso at caf√©s. </b> This is my favourite way
		start the morning on day's when we have time.</p>

		<p><b> Baking sourdough. </b> I'm a bread fanatic and some weeks 
		I'll bake (and eat) three loaves.
		In the summer you pay a double price for this
		because not only is your oven using <i>a lot</i> of power, but we also 
		don't have air conditioning and the waste heat is hard to get out of
		the house.  In the winter, baking is a very efficient thing to do
		because you get to use that energy twice: once to bake your bread,
		once to heat your house.</p>

		<p><b> More time with friends. </b> Easier when your less busy.</p>

		<p><b> Commuting by bike. </b> Last winter, the TTC was the bane of 
		my existence.  I started commuting my bike this spring and have 
		realized that it is vastly superior to transit.  It'll be a bit more
		of an adventure in the winter, but I'm anticipating it raising my 
		overall standard of living.</p>

		<p><b> Planning next summer's adventures. </b> Enough said.</p>

		<!-- -->
		<h1><a name=inverse> Sept 29, 2011:<span class="dark"> The Binomial Inverse
			  theorem</span></a></h1>
		<p> Here is a matrix trick that I'm sure I wasn't taught in school 
		(although my undergrad was embarrassingly lacking in linear algebra).
		Let me prefix everything by saying that I'm currently working on a map
		making code for the 21 cm experiment I'm involved in.  Map making is
		big business in the CMB community and I'm trying to translate what is
		used there to 21 cm.  Map making is all about linear algebra and
		dealing with large matrices and one of the big challenges is inverting
		some of these matrices.</p>

		<p>The <a href="http://en.wikipedia.org/wiki/Binomial_inverse_theorem"> 
		  binomial inverse theorem</a> tells you how to invert sums of
		matrices for which you already know the inverses.  For a general pair of
		matrices it isn't that useful, since applying the formula is as much work
		as computing an inverse the normal way.  Where the theorem comes in
		handy is when one of the matrices is of low rank.  Lets you have an 
		<i>(n*n)</i> matrix <i>A</i> for which you already have the inverse.
		You have another matrix <i>B</i> that is the same size but only has rank
		<i>m</i> which is a relatively small number.  The inverse of their sum
		can be computed in <i>O(m*n<sup>2</sup>)</i> operations instead of the
		normal <i>O(n<sup>3</sup>)</i>.  This is assuming you already know how
		to rotate <i>B</i> to an <i>(m*m)</i> dense matrix, but this is probably
		how you got <i>B</i> in the first place 
		(or else why would it have such a low rank?).</p>

		<p> All fine and good, but I still need to invert <i>A</i> so I haven't
		gained anything.  This brings us to where the theorem is <b>really</b>
		useful; if <i>A</i> of is full rank but is diagonal or block diagonal.
		This symmetry lets you invert and multiply by <i>A</i> quickly but
		does nothing for <i>A+B</i> unless you use binomial inverse theorem.
		This might seem like a pretty limited range of applicability but this
		situation has come up no less than 3 times in my map making code.</p>
		
		<p> I'm only writing about this wonderful identity because it doesn't 
		seem to be common knowledge in my field.  It's been so useful I figured
		it would be in every map making reference around.  
		</p>
		<!-- -->
      </div>
      <!-- Left end -->
    </div>
    <!-- #columns end -->
  </div>
  <!-- #page end -->
</div>
<!-- #content end -->
<!-- #footer: holds the site footer (logo and links) -->
<div id="footer">
  <!-- #bg: applies the site width and footer background -->
  <div id="bg" class="width">
	  <br/>
	  Kiyoshi Wesley Masui &nbsp;&nbsp; kiyo _at_ cita _dot_ utoronto.ca &nbsp;&nbsp; tel: 416 978 5861
      &nbsp;&nbsp; office: <a href="http://cita.utoronto.ca/index.php/Contact-Visitor-Info">MP</a> 1318
  </div>
  <!-- #bg end -->
</div>
<!-- #footer end -->
</body>
</html>
